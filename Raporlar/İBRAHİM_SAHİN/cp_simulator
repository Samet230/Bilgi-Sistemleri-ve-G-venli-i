

# -*- coding: utf-8 -*-
import asyncio
import logging
import websockets
from datetime import datetime, timezone
import traceback

# â­ Ä°LK Ã–NCE LOGGING
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s | %(levelname)s | %(message)s',
    force=True
)

import can
from ocpp.routing import on
from ocpp.v201 import ChargePoint as CP
from ocpp.v201 import call_result, call

# Global bus tanÄ±mÄ±
try:
    bus = can.interface.Bus(interface='virtual', channel='vcan0')
    logging.info("âœ… CAN Bus baÅŸarÄ±yla baÅŸlatÄ±ldÄ±")
except Exception as e:
    logging.warning(f"âš ï¸ CAN Bus baÅŸlatÄ±lamadÄ±: {e}")
    bus = None


class ChargePointSimulator(CP):

    async def _complete_transaction_tasks_async(self, can_id, payload):
        """CAN gÃ¶nderme ve MeterValues simÃ¼lasyonunu asenkron olarak yapar."""
        try:
            logging.info("[CP] Arka plan gÃ¶revi baÅŸladÄ±...")

            # CAN MesajÄ±nÄ± GÃ¶nder
            data = [1, *payload]
            msg = can.Message(arbitration_id=can_id, data=data, is_extended_id=False)
            logging.info(f"*** KÃ–PRÃœLEME (BRIDGE) *** OCPP -> CAN: ID 0x{can_id:X}, Data: {data}")

            if bus is not None:
                await asyncio.to_thread(bus.send, msg)
                logging.info("[CP] CAN mesajÄ± gÃ¶nderildi")

            # Charger CevabÄ±nÄ± SimÃ¼le Et ve MeterValues GÃ¶nder
            await self.simulate_charger_response()

        except Exception as e:
            logging.error(f"[CP] _complete_transaction_tasks_async hatasÄ±: {e}")
            logging.error(traceback.format_exc())

    async def simulate_charger_response(self):
        """Charger modÃ¼lÃ¼nden MeterValues cevabÄ± gelmiÅŸ gibi yapar ve CSMS'e gÃ¶nderir."""
        try:
            logging.info("[CP] Charger response simÃ¼le ediliyor...")

            # KÄ±sa bir gecikme
            await asyncio.sleep(0.5)

            meter_can_id = 0x300
            meter_data = [1, 50, 0, 0]
            meter_msg = can.Message(arbitration_id=meter_can_id, data=meter_data, is_extended_id=False)

            if bus is not None:
                await asyncio.to_thread(bus.send, meter_msg)
                logging.info(f"CAN CEVAP GÃ–NDERÄ°LDÄ° (SimÃ¼le EdilmiÅŸ Meter): ID 0x{meter_can_id:X}")

            # CSMS'e MeterValues gÃ¶nderme
            logging.info("[CP] MeterValues hazÄ±rlanÄ±yor...")
            request = call.MeterValues(
                evse_id=1,
                meter_value=[
                    {'timestamp': datetime.now(timezone.utc).isoformat().replace('+00:00','Z'),
                     'sampled_value': [{'value': 500 }]}
                ]
            )

            await self.call(request)
            logging.info("âœ… OCPP MeterValues CSMS'e gÃ¶nderildi.")

        except Exception as e:
            logging.error(f"[CP] simulate_charger_response hatasÄ±: {e}")
            logging.error(traceback.format_exc())

    @on('RequestStartTransaction')
    async def on_request_start_transaction(self, remote_start_id, id_token, evse_id=None, **kwargs):
        """CSMS'ten RequestStartTransaction gelirse Ã§alÄ±ÅŸÄ±r."""
        try:
            logging.info("=" * 60)
            logging.info(f"[CP] ğŸ¯ RequestStartTransaction ALINDI!")
            logging.info(f"[CP] remote_start_id: {remote_start_id}")
            logging.info(f"[CP] id_token: {id_token}")
            logging.info(f"[CP] evse_id: {evse_id}")
            logging.info(f"[CP] kwargs: {kwargs}")
            logging.info("=" * 60)

            can_id = 0x200
            payload = [1, evse_id or 1, 1]

            logging.info(f"[CP] Arka plan gÃ¶revi baÅŸlatÄ±lÄ±yor...")
            asyncio.create_task(self._complete_transaction_tasks_async(can_id, payload))

            logging.info(f"[CP] RequestStartTransaction Accepted yanÄ±tÄ± dÃ¶ndÃ¼rÃ¼lÃ¼yor...")

            return call_result.RequestStartTransaction(status='Accepted')

        except Exception as e:
            logging.error(f"[CP] on_request_start_transaction hatasÄ±: {e}")
            logging.error(traceback.format_exc())
            return call_result.RequestStartTransaction(status='Rejected')

    @on('RequestStopTransaction')
    async def on_request_stop_transaction(self, transaction_id, **kwargs):
        """CSMS'ten RequestStopTransaction gelirse Ã§alÄ±ÅŸÄ±r."""
        try:
            logging.info(f"[CP] RequestStopTransaction ALINDI!")
            logging.info(f"[CP] transaction_id: {transaction_id}")
            return call_result.RequestStopTransaction(status='Accepted')
        except Exception as e:
            logging.error(f"[CP] on_request_stop_transaction hatasÄ±: {e}")
            logging.error(traceback.format_exc())
            return call_result.RequestStopTransaction(status='Rejected')


async def main():
    print("=" * 60)
    print("ğŸš€ CP SIMULATOR BAÅLIYOR...")
    print("=" * 60)

    logging.info("CP Simulator baÅŸlatÄ±lÄ±yor...")

    csms_url = 'ws://127.0.0.1:9000/CP_TEST'
    cp_id = 'CP_TEST'

    try:
        logging.info(f"[CP] CSMS'e baÄŸlanÄ±lÄ±yor: {csms_url}")

        async with websockets.connect(csms_url, subprotocols=['ocpp2.0.1']) as ws:
            logging.info("âœ… [CP] WebSocket baÄŸlantÄ±sÄ± kuruldu")

            cp = ChargePointSimulator(cp_id, ws)

            # â­ KRÄ°TÄ°K: Ã–nce cp.start()'Ä± arka planda baÅŸlat
            start_task = asyncio.create_task(cp.start())

            # KÄ±sa bir bekleme - cp.start() mesaj dinlemeye baÅŸlasÄ±n
            await asyncio.sleep(0.5)

            # BootNotification gÃ¶nder
            logging.info("[CP] BootNotification gÃ¶nderiliyor...")

            request = call.BootNotification(
                reason="PowerUp",
                charging_station={
                    "model": "SimChargePoint",
                    "vendor_name": "SimVendor"
                }
            )

            response = await cp.call(request)
            logging.info(f"âœ… [CP] BootNotification cevabÄ±: {response.status}")

            logging.info("ğŸ§ [CP] SimÃ¼latÃ¶r Ã§alÄ±ÅŸÄ±yor, mesaj bekleniyor...")
            logging.info("=" * 60)

            # start_task'Ä±n bitmesini bekle
            await start_task

    except websockets.exceptions.ConnectionClosedError as e:
        logging.error(f"âŒ [CP] WebSocket HatasÄ±: {e}")
    except Exception as e:
        logging.error(f"âŒ [CP] Beklenmedik Hata: {e}")
        logging.error(traceback.format_exc())
    finally:
        if bus is not None:
            bus.shutdown()
            logging.info("CAN VirtualBus baÅŸarÄ±yla kapatÄ±ldÄ±.")


if __name__ == '__main__':
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\n")
        logging.info("ğŸ›‘ [CP] SimÃ¼latÃ¶r kullanÄ±cÄ± tarafÄ±ndan kapatÄ±ldÄ±.")



