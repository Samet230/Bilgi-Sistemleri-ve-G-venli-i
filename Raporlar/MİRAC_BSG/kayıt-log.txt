import json
from datetime import datetime

# --- Ayarlar ---
JSON_DOSYA_ADI = "sarj_loglari_yanlis_kayit.json"
MAX_PLAKA_TEKRAR_DAKIKA = 2    # 2 dakikadan kısa sürede aynı plaka şüpheli
MIN_GUÇ_KW = 0.1              # çok düşük güç alt sınır
MAX_GUÇ_KW = 350.0            # çok yüksek güç üst sınır

def anomali_analizi_yap():
    print(f"--- ANALİZ BAŞLIYOR: {JSON_DOSYA_ADI} ---\n")
    
    try:
        with open(JSON_DOSYA_ADI, 'r', encoding='utf-8') as f:
            loglar = json.load(f)
    except FileNotFoundError:
        print("Hata: JSON dosyası bulunamadı. Önce veri üretici kodunu çalıştırın.")
        return

    anomali_sayisi = 0
    toplam_islem = len(loglar)
    son_plaka_zamanlari = {}  # NORMALIZE_PLAKA -> datetime

    for log in loglar:
        # 1. Verileri ayıkla
        server_time_str = log["time"]
        details = log["details"]
        station_id = details["station"]
        user_id = details["user"]

        input_name = details["input_name"]
        input_plate = details["input_plate"]
        registered_name = details["registered_name"]
        registered_plate = details["registered_plate"]
        tariff = details.get("tariff", "BILINMIYOR")
        energy_kwh = details.get("energy_kwh", 0.0)
        duration_min = details.get("duration_min", 0)

        # Sunucu zamanı ISO'dan datetime'a
        server_dt = datetime.fromisoformat(server_time_str)

        is_fraud = False
        sebepler = []

        # 2. Algılama Kuralı 1: İsim/Plaka uyuşmazlığı
        # Basit olarak case-insensitive ve boşlukları kırpıyoruz
        def norm_text(t): 
            return t.strip().lower()

        def norm_plate(p):
            return p.replace(" ", "").upper()

        isim_dogru = (norm_text(input_name) == norm_text(registered_name))
        plaka_dogru = (norm_plate(input_plate) == norm_plate(registered_plate))

        if not isim_dogru and plaka_dogru:
            is_fraud = True
            sebepler.append("YANLIS_ISIM (Giriş ismi, kayıtlı isimle uyuşmuyor)")
        elif isim_dogru and not plaka_dogru:
            is_fraud = True
            sebepler.append("YANLIS_PLAKA (Giriş plakası, kayıtlı plakayla uyuşmuyor)")
        elif not isim_dogru and not plaka_dogru:
            is_fraud = True
            sebepler.append("YANLIS_ISIM_VE_PLAKA (Her ikisi de uyuşmuyor)")

        # 3. Algılama Kuralı 2: Kısa aralıkla tekrar eden plaka
        plaka_key = norm_plate(input_plate)
        onceki_zaman = son_plaka_zamanlari.get(plaka_key)

        if onceki_zaman is not None:
            fark_sn = (server_dt - onceki_zaman).total_seconds()
            fark_dk = fark_sn / 60
            if fark_dk < MAX_PLAKA_TEKRAR_DAKIKA:
                is_fraud = True
                sebepler.append(
                    f"KISA_ARALIKLA_TEKRAR_PLAKA (Son {fark_dk:.1f} dk içinde aynı plaka)"
                )

        # Her durumda son zamanı güncelle (anomali olsa da olmasa da)
        son_plaka_zamanlari[plaka_key] = server_dt

        # 4. Algılama Kuralı 3: Mantıksız güç değeri
        if duration_min > 0:
            avg_power_kw = energy_kwh / (duration_min / 60.0)
            if avg_power_kw < MIN_GUÇ_KW or avg_power_kw > MAX_GUÇ_KW:
                is_fraud = True
                sebepler.append(
                    f"MANTIKSIZ_GUÇ_DEGERI (Ortalama güç: {avg_power_kw:.1f} kW)"
                )

        # 5. Karar ve Tepki
        if is_fraud:
            anomali_sayisi += 1
            print(f"[ALARM] İstasyon: {station_id} | Kullanıcı: {user_id}")
            print(f"   Zaman          : {server_time_str}")
            print(f"   Tarife         : {tariff}")
            print(f"   Enerji/Süre    : {energy_kwh} kWh / {duration_min} dk")
            print(f"   İsim (giriş/kayıtlı): '{input_name}' / '{registered_name}'")
            print(f"   Plaka (giriş/kayıtlı): '{input_plate}' / '{registered_plate}'")
            print(f"   Tespit Edilen Sorunlar: {', '.join(sebepler)}")
            print(f"   Aksiyon: Oturum incelemeye alındı, faturalama manuel kontrol edilecek.")
            print("-" * 70)
            
    # Sonuç Raporu
    print(f"\n--- ANALİZ TAMAMLANDI ---")
    print(f"Toplam İncelenen Kayıt: {toplam_islem}")
    print(f"Tespit Edilen Anomali: {anomali_sayisi}")
    if toplam_islem > 0:
        basari_orani = (anomali_sayisi / toplam_islem) * 100
        print(f"Anomali Oranı: %{basari_orani:.1f}")
    else:
        print("Log kaydı bulunamadı.")

if __name__ == "__main__":
    anomali_analizi_yap()
