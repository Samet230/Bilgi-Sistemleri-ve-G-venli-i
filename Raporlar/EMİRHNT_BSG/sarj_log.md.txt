import json
from datetime import datetime

# --- Ayarlar ---
JSON_DOSYA_ADI = "sarj_loglari.json"
MAX_ZAMAN_FARKI_DAKIKA = 15  # 15 dakikadan fazla fark ÅŸÃ¼phelidir

def anomali_analizi_yap():
    print(f"--- ANALÄ°Z BAÅLIYOR: {JSON_DOSYA_ADI} ---\n")
    
    try:
        with open(JSON_DOSYA_ADI, 'r', encoding='utf-8') as f:
            loglar = json.load(f)
    except FileNotFoundError:
        print("Hata: JSON dosyasÄ± bulunamadÄ±. Ã–nce veri Ã¼retici kodunu Ã§alÄ±ÅŸtÄ±rÄ±n.")
        return

    anomali_sayisi = 0
    toplam_islem = len(loglar)

    for log in loglar:
        # 1. Verileri AyÄ±kla
        server_time_str = log["time"]
        details = log["details"]
        station_id = details["station"]
        user_id = details["user"]
        
        # Zaman formatlarÄ±nÄ± iÅŸle (ISO formatÄ±ndan datetime objesine Ã§evir)
        # Ã–rnek Server Time: "2025-11-10T22:31:12+03:00"
        server_dt = datetime.fromisoformat(server_time_str)
        
        # Cihaz saati JSON'da sadece "HH:MM" olarak saklanmÄ±ÅŸtÄ± ("03:30" gibi)
        local_time_str = details["local_device_time"]
        local_hour, local_minute = map(int, local_time_str.split(":"))
        
        # KarÅŸÄ±laÅŸtÄ±rma iÃ§in cihaz tarihini, sunucu tarihiyle aynÄ± gÃ¼n varsayÄ±yoruz
        # (Sadece saatin manipÃ¼le edildiÄŸi senaryosu)
        local_dt = server_dt.replace(hour=local_hour, minute=local_minute, second=0)

        # 2. AlgÄ±lama KuralÄ± 1: Zaman FarkÄ± Analizi [Kaynak: 17]
        # "Sunucu saati ile cihaz saati arasÄ±nda bÃ¼yÃ¼k fark oluÅŸmasÄ±"
        zaman_farki_sn = abs((server_dt - local_dt).total_seconds())
        zaman_farki_dk = zaman_farki_sn / 60

        # 3. AlgÄ±lama KuralÄ± 2: Tarife TutarsÄ±zlÄ±ÄŸÄ± [Kaynak: 16]
        # "Enerji tÃ¼ketimi ile faturalama verileri arasÄ±nda tutarsÄ±zlÄ±k"
        uygulanan = details["applied_tariff"]
        beklenen = details["expected_tariff"]
        
        is_fraud = False
        sebepler = []

        # Kural kontrolleri
        if zaman_farki_dk > MAX_ZAMAN_FARKI_DAKIKA:
            is_fraud = True
            sebepler.append(f"Zaman Senkronizasyon HatasÄ± ({int(zaman_farki_dk)} dk fark)")
        
        if uygulanan != beklenen:
            is_fraud = True
            sebepler.append(f"Tarife ManipÃ¼lasyonu (Uygulanan: {uygulanan}, OlmasÄ± Gereken: {beklenen})")

        # 4. Karar ve Tepki [Kaynak: 19]
        if is_fraud:
            anomali_sayisi += 1
            print(f"ğŸš¨ [ALARM] Ä°stasyon: {station_id} | KullanÄ±cÄ±: {user_id}")
            print(f"   Zaman: {server_time_str}")
            print(f"   Tespit Edilen Sorunlar: {', '.join(sebepler)}")
            print(f"   Aksiyon: Oturum incelemeye alÄ±ndÄ± ve faturalama durduruldu.")
            print("-" * 50)
            
    # SonuÃ§ Raporu
    print(f"\n--- ANALÄ°Z TAMAMLANDI ---")
    print(f"Toplam Ä°ncelenen KayÄ±t: {toplam_islem}")
    print(f"Tespit Edilen Anomali: {anomali_sayisi}")
    basari_orani = (anomali_sayisi / toplam_islem) * 100
    print(f"Anomali OranÄ±: %{basari_orani:.1f}")

if __name__ == "__main__":
    anomali_analizi_yap()